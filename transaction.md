# 트랜잭션

-----

### 트랜잭션 
- 더 이상 쪼갤 수 없는 작업 단위
- 논리적인 작업셋을 모두 완벽하거나 또는 처리하지 못할 경우 원상태로 복구해서 작업의 일부만 적용되는 현상을 막아 작업의 완전성을 보장한다.

### ACID (트랜잭션의 특징 4가지)
- 원자성 : 모두 반영되거나 모두 반영되지 않아야한다
- 일관성 : 트랜잭션이 성공적으로 완료되면 일관적인 DB상태를 유지해야 한다 (데이터 타입이나 상태가 변하지 않은것을 의미)
- 격리성(고립성) : 하나의 트랜잭션이 작업을 수행 중일 때 다른 트랜잭션이 끼어들 수 없다 (트랙잭션들끼리 독립적으로 실행되야함)
- 지속성 : 트랜잭션이 성공적으로 완료되면 수행된 트랜잭션은 영원히 유지된다. 즉, 다른 트랜잭션이 실행되기 전까지는 영원히 보존되어야 한다.

### 잠금과 트랜잭션의 차이 
- 잠금은 동시성을 제어하기 위한 기능
- 트랜잭션은 데이터의 정합성을 보장하기 위한 기능
하나의 회원 정보를 여러개의 Connection이 동시에 변경하려고 하는데 Lock 기능이 없다면 여러개의 커넥션에서 동시에 변경할 수 있어 동시성의 문제가 발생한다.
 > 즉, Lock 기능은 여러 커넥션에서 동시에 동일한 자원을 요청할 경우 순서대로 한 시점에는 하나의 커넥션만 변경할 수 있도록 해준다.

### MYSQL에서 트랜잭션
- 작업 셋 자체가 100% 적용되거나 아무것도 적용되지 않아야한다.
- InnoDB 스토리지 엔진은 쿼리 중 일부라도 오류가 발생하면 전체를 원 상태로 만든다는 트랜잭션의 원칙을 지킨다.

```java
INSERT INTO tbl_professor(professor_no) values(3)
 
INSERT INTO tbl_professor(professor_no) values (1),(2),(3)

result : 3
```
- 위와 같이 InnoDB는 쿼리 중 일부라도 오류가 있으면 전체를 원 상태로 만든다는 트랜잭션의 원칙대로 INSERT 문장을 실행 이전으로 돌린다.

MYSQL의 기본 트랜잭션은 auto Commit으로 설정되어있다. 그렇기 때문에 update query를 날려도 바로 DB에 반영이 된다.
```java
INSERT INTO tbl_professor(professor_no) values(1)
INSERT INTO tbl_professor(professor_no) values(2)
INSERT INTO tbl_professor(professor_no) values(3)
```
- 위 쿼리문에서 트랜잭션은 몇 번이나 발생했는가?
  > 3개를 하나로 묶어서 트랜잭션이 한번만 발생한 것처럼 보일 수 있으나, 트랜잭션은 세번 발생했다. 트랜잭션은 더 이상 쪼갤 수 없는 작업 단위이고, MYSQL은 일반적으로 AUTO Commit 상태이기 때문이다.

### 주의사항
- 트랜잭션 또한 DBMS의 커넥션과 동일하게 꼮 필요한 최소의 코드에만 적용하는 것이 좋다.
- 프로그램 코드에서 트랜잭션 범위를 최소화 하자.

  아래와 같은 프로세스 절차를 살펴보자
  


---
1. 처리 시작
   - DB connection 생성 및 transaction 시작
2. 사용자의 로그인 여부 확인
3. 사용자의 글쓰기 내용의 오류 여부 확인
4. 첨부로 업로드된 파일 확인 및 저장
5. 사용자의 입력 내용을 DBMS에 저장
6. 첨부파일 정보를 DBMS에 저장
7. 저장된 내용 또는 기타 정보를 DBMS에서 조회
8. 게시물 등록에 대한 알림 메일 발송
9. 알림 메일 발송 이력을 DBMS에 저장
  - 트랜잭션 종료 (commit)
  - DB Connection 반납
10. 처리 완료

아래와 같이 변경하자
---
1. 처리 시작
2. 사용자의 로그인 여부 확인
3. 사용자의 글쓰기 내용의 오류 발생 여부 확인
4. 첨부로 업로드된 파일 확인 및 저장
   -> DB 커넥션 생성
   -> 트랜잭션 시작
5. 사용자의 입력 내용을 DBMS에 저장
6. 첨부 파일 정보를 DBMS에 저장
   -> 트랜잭션 커밋(종료)
7. 저장된 내용 또는 기타 정보를 DBMS에서 조회
8. 게시물 등록에 대한 메일 발송
   -> 트랜잭션 시작
9. 알림메일 발송 이력을 DBMS에 저장
   -> 트랜잭션 커밋
   -> DB Connection

1. 처리 완료
   - 이유
   i. DB Connection은 개수가 제한적이다. 각 단위 프로그램이 커넥션을 소유하는 시간이 길어질수록 사용가능한 여유 커넥션의 개수가 줄어든다.
   ii. 네트워크와 통신하는 작업은 반드시 DBMS 트랜잭션 내에서 제거해야 한다. 프로그램이 실행되는 동안 메일 서버와 통신 할 수 없는 상황이 발생하면
       웹 서버 뿐 아니라 DBMS도 장애가 발생할 수 있다.
     
